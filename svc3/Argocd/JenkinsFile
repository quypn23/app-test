pipeline {
    agent any
    
    triggers {
        pollSCM('* * * * *')
    }

    environment {
        GIT_MANIFEST_REPO = 'https://github.com/quypn23/argocd.git'
        GIT_CODE_REPO = 'https://github.com/quypn23/app-test.git'
    }
    
    stages {
        stage('Detect Changes & Build') {
            steps {
                script {
                    cleanWs()
                    echo "--- 1. Checkout Code ---"
                    checkout([
                        $class: 'GitSCM', 
                        branches: [[name: '*/main']], 
                        userRemoteConfigs: [[url: GIT_CODE_REPO, credentialsId: 'github']]
                    ])

                    // --- 2. TÃŒM CÃC SERVICE Bá»Š THAY Äá»”I ---
                    // Lá»‡nh git diff láº¥y danh sÃ¡ch file thay Ä‘á»•i trong commit gáº§n nháº¥t
                    def changedFiles = sh(script: "git diff --name-only HEAD~1 HEAD", returnStdout: true).trim()
                    echo "Files changed:\n${changedFiles}"
                    
                    // Logic tÃ¡ch tÃªn thÆ° má»¥c (svc1, svc2...) tá»« Ä‘Æ°á»ng dáº«n file
                    def servicesToBuild = []
                    
                    changedFiles.split('\n').each { file ->
                        def parts = file.split('/')
                        if (parts.length > 1) {
                            def folderName = parts[0] // Láº¥y folder gá»‘c (vÃ­ dá»¥: svc1)
                            
                            // Chá»‰ thÃªm vÃ o danh sÃ¡ch náº¿u folder Ä‘Ã³ cÃ³ chá»©a file param.txt
                            if (fileExists("${folderName}/param.txt")) {
                                servicesToBuild.add(folderName)
                            }
                        }
                    }
                    
                    // Loáº¡i bá» trÃ¹ng láº·p (náº¿u sá»­a 2 file trong cÃ¹ng 1 folder)
                    servicesToBuild = servicesToBuild.unique()
                    
                    if (servicesToBuild.size() == 0) {
                        echo "âš ï¸ KhÃ´ng cÃ³ service nÃ o thay Ä‘á»•i cáº¥u hÃ¬nh. Bá» qua Build."
                        return // Káº¿t thÃºc
                    }
                    
                    echo "ðŸš€ DANH SÃCH Cáº¦N BUILD: ${servicesToBuild}"

                    // --- 3. VÃ’NG Láº¶P BUILD Tá»ªNG SERVICE ---
                    servicesToBuild.each { serviceFolder ->
                        echo "=========================================="
                        echo "       START PROCESSING: ${serviceFolder}"
                        echo "=========================================="
                        
                        // A. Äá»ŒC Cáº¤U HÃŒNH
                        def props = readProperties file: "${serviceFolder}/param.txt"
                        def SV_NAME = props['SERVICE_NAME'].trim()
						def REPLICA = props['REPLICA'].trim()
                        def PROJ = props['ARGOCD_PROJECT'].trim()
                        def NS = props['NAMESPACE'].trim()
                        def IMAGE = "admiral2523/${SV_NAME}"
                        
                        // B. BUILD DOCKER
                        dir(serviceFolder) {
                            currentBuild.displayName = "${IMAGE}-${BUILD_NUMBER}"
                            sh "docker build -t ${IMAGE}:${BUILD_NUMBER} ."
                            withCredentials([usernamePassword(credentialsId: 'dockerhub', passwordVariable: 'DPASS', usernameVariable: 'DUSER')]) {
                                sh "docker login -u $DUSER -p $DPASS"
                                sh "docker push ${IMAGE}:${BUILD_NUMBER}"
                            }
                        }
                        
                        // C. UPDATE MANIFEST (GITOPS)
                        withCredentials([usernamePassword(credentialsId: 'github', passwordVariable: 'GPASS', usernameVariable: 'GUSER')]) {
                            // Clone vÃ o folder riÃªng cho tá»«ng service Ä‘á»ƒ trÃ¡nh conflict
                            def workspaceName = "gitops-${SV_NAME}"
                            sh "rm -rf ${workspaceName}"
                            
                            sh """
                                git config --global credential.helper store
                                echo "https://${GUSER}:${GPASS}@github.com" > ~/.git-credentials
                                git clone ${GIT_MANIFEST_REPO} ${workspaceName}
                            """
                            
                            dir(workspaceName) {
                                def targetDir = "gitOps-repo/values/${SV_NAME}"
                                def valuesFile = "${targetDir}/values.yaml"
                                def configFile = "${targetDir}/config.json"
                                
                                sh """
                                    mkdir -p ${targetDir}
                                    
                                # --- 3. Táº O FILE CONFIG.JSON (Tá»± Ä‘á»™ng) ---
                                # LuÃ´n ghi Ä‘Ã¨ file nÃ y Ä‘á»ƒ Ä‘áº£m báº£o cáº­p nháº­t project má»›i nháº¥t náº¿u báº¡n Ä‘á»•i Ã½
                                echo 'Creating config.json...'
cat <<EOF > ${configFile}
{
  "appName": "${SV_NAME}",
  "projectName": "${PROJ}",
  "destNamespace": "${NS}"
}
EOF

                                    # Values.yaml
                                    if [ ! -f "${valuesFile}" ]; then
                                        echo "Creating values.yaml..."
                                        cat <<EOF > ${valuesFile}
replicaCount: "${REPLICA}"
image:
  repository: "${IMAGE}"
  tag: "${BUILD_NUMBER}"
service:
  port: 80
EOF
                                    else
                                        echo "Updating values.yaml..."
                                        sed -i 's|replicaCount: ".*"|replicaCount: "${REPLICA}"|g' ${valuesFile}
                                        sed -i 's|repository: ".*"|repository: "${IMAGE}"|g' ${valuesFile}
                                        sed -i 's|tag: ".*"|tag: "${BUILD_NUMBER}"|g' ${valuesFile}
                                    fi
                                    
                                    # Git Push
                                    git config user.email 'jenkins@bot.com'
                                    git config user.name 'Jenkins Bot'
                                    git add ${targetDir}
                                    git commit -m "Auto-Deploy ${SV_NAME} build ${BUILD_NUMBER}" || echo "No changes"
                                    git pull --rebase origin main || true
                                    git push origin main
                                """
                            }
                        }
                        echo "âœ… DONE SERVICE: ${SV_NAME}"
                    }
                }
            }
        }
    }
}